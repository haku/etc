#!/usr/bin/env ruby
require 'find'
require 'open3'
require 'filesize'

def gen_par(dir, files)
  puts "  protecting #{files.size} files ... "
  Dir.chdir(dir) do
    Open3.popen3('par2', 'c', '-r10', '-q', '--', "#{File.basename(dir)}.par2", *files) do |i, o, e, t|
      while line = o.gets
      end
      err = e.readlines
      err.each{|l| puts "    #{l}"}
      t.value.success? ? nil : ([ "generate failed: #{dir} [#{t.value}]" ] + err)
    end
  end
  puts "  #{files.size} files protected (#{Filesize.new(par_size(dir)).pretty} of par2)."
end

def ver_par(dir, all_files)
  puts "  verifying #{all_files.size} files... "
  prot_files = []
  res = Dir.chdir(dir) do
    Open3.popen3('par2', 'v', '-q', '--', "#{File.basename(dir)}.par2") do |i, o, e, t|
      while line = o.gets
        prot_file = line[/^Target: "(.+)" - found\.$/, 1]
        prot_files << prot_file if prot_file
      end
      err = e.readlines
      err.each{|l| puts "    #{l}"}
      t.value.success? ? nil : ([ "verify failed: #{dir} [#{t.value}]" ] + err)
    end
  end
  return res if res

  puts "  #{prot_files.size} files verified (#{Filesize.new(par_size(dir)).pretty} of par2)."

  new_files = all_files - prot_files
  if new_files.size > 0
    puts "  #{new_files.size} unprotected files:"
    new_files.each{|f| puts "    #{f}"}
    gen_par(dir, all_files)
  end
end

def par_size(dir)
  Dir.chdir(dir) do
    Dir.entries(dir).select{|e| e.end_with?('.par2')}.inject(0){|sum, f| sum += File.size(f)}
  end
end

errors = []
base_dir = "#{Dir.pwd}/"
Find.find(base_dir) do |d|
  next if !FileTest.directory?(d)

  files = Dir.entries(d)
  par2_files = files.select{|e| e.end_with?('.par2')}
  data_files = (files - par2_files).select{|e| File.file?("#{d}/#{e}")}

  if data_files.size > 0
    puts d.gsub(base_dir, './')

    if par2_files.size > 0
      res = ver_par(d, data_files)
      errors << res if res
    else
      res = gen_par(d, data_files)
      errors << res if res
    end
  end
end

if errors.size > 0
  puts "#{errors.size} errors:"
  errors.each do |e|
    puts "  #{e.shift}"
    e.each{|l| puts "    #{l}"}
  end
  exit 1
end

puts 'success.'
