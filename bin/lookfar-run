#!/bin/bash
set -eu

log() {
  echo $(date +'%Y%m%d-%H%M%S') $@
}

lf_rc="$HOME/.lookfarrc"
if ! [ -e "$lf_rc" ] ; then
  log "missing: $lf_rc"
  exit 1
fi
source "$lf_rc"

if [[ "$1" == var=* ]] ; then
  lf_var="${1#var=}"
  shift
fi

lf_cmd="$1"; shift
if [ -z "${lf_var:-}" ] ; then
  lf_var="$(basename "$lf_cmd")"
fi
lf_result=""
lf_node="$(hostname -s)"

lf_send_result () {
  #log "$(date +'%Y%m%d-%H%M%S') Sending '$lf_var=$lf_result' Lookfar... "
  curl --silent \
    -u "$LF_USER" \
    -d "$lf_var=$lf_result" \
    "https://$LF_HOST/update/$lf_node"
  log "done."
}

trap "exit" INT TERM
trap "lf_send_result" EXIT

set +e
$lf_cmd "$@"
lf_result="$?"
exit $lf_result
