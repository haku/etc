#!/bin/bash
set -eu

# http://manual.calibre-ebook.com/generated/en/ebook-convert.html

if [[ "$0" == */kindlify ]] ; then
  mode="kindle"
  device="/media/$USER/Kindle/documents"
  ext="mobi"
elif [[ "$0" == */nookify ]] ; then
  mode="nook"
  device="/media/$USER/NOOK/My Files/Books"
  ext="epub"
else
  echo "Unknown mode: $0"
  exit 1
fi

f_samedir=''

while [ $# -gt 0 ]
do
  case "$1" in
    --samedir) f_samedir='1';;
    --) shift; break;;
    -*) echo - "Illegal flags" "$@" ; exit 1;;
    *) break;;
  esac
  shift
done

for input in "$@" ; do
  echo -e "\n == $input =="

  args=()

  title="${input%.*}"
  args+=('--title' "$title")

  if [[ "$input" == *".html" ]] ; then
    args+=('--filter-css' 'color,font-family')
  fi

  echo -e "    => ${args[@]:-}"

  output="$(basename "$input").$mode.$ext"
  echo -e "    => $output\n"

  ebook-convert "$input" "$output" --output-profile $mode "${args[@]:+${args[@]}}"

  if [ -e "$device" ] ; then
    dest_dir="$device"
    if [ "$f_samedir" == '1' ] ; then
      dir_name="$(basename "$(dirname "$(readlink -e "$input" )" )" )"
      dest_dir="$dest_dir/$dir_name"
      if ! [ -e "$dest_dir" ] ; then
        mkdir -v "$dest_dir"
      fi
    fi

    dest_file="$dest_dir/$output"
    if ! [ -e "$dest_file" ] ; then
      echo -e "\n    => $dest_file\n"
      cp "$output" "$dest_file"
    fi
  fi
done
