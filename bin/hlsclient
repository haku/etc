#!/bin/bash
set -eu

mnf="$1"

fetch() {
  curl --silent --user-agent 'hlsclient' "$@"
}

while true ; do
  chunks=()
  while read line ; do
    if [[ "$line" =~ ^([^#].*)$ ]] ; then
      chunks+=("${BASH_REMATCH[1]}")
    fi
  done < <(fetch "$mnf")
  if [ ${#chunks[@]} -gt 0 ]; then
    for chunk in ${chunks[@]}; do
      if [ -e "$chunk" ] ; then continue ; fi
      echo -n "chunk: $chunk "
      fetch "$(dirname "$mnf")/$chunk" > "./$chunk"
      echo "done."
    done
  fi
  sleep 1
done

